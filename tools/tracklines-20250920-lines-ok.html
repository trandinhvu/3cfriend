<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Billiards</title>
    <link rel="stylesheet" href="style/canvas.css">
  </head>
  <body onload="draw();">
    <div id="container">
      <canvas id="mainCanvas"></canvas>
      <!-- 310x168 -->
      <script>
        var canvasWidth = 1000;
        var canvasHeight = 574;
        var xWhite = 500;
        var yWhite = 287;
        var bgColor = '#333';
        var ballRadius = 9.225;
        var tableColor = '#37f';
        var railColor = '#000';
        var cushionColor = '#15f';
        var gridColor = '#48f';
        var marginRail = 35;
        var marginCushion = 56;
        var marginClothe = 74;
        var marginDiamond = 46;
        var spaceGrid = (canvasWidth - (marginClothe*2))/8;
        var diamondColor = '#fff';
        var makerColor = '#fff';

        var canvas = document.getElementById("mainCanvas");
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        var context = canvas.getContext("2d");
        canvas.addEventListener('mousedown', mouseDown, false);
        canvas.addEventListener("dblclick", doubleClick, false);
        canvas.addEventListener("touchstart", mouseDown, false);
        canvas.addEventListener("touchmove", doubleClick, false);

        function draw() {
          context.beginPath();
          context.arc(0, 0, 0, 0, 2 * Math.PI, false);
          context.fillStyle = 0;
          context.fill();
          //background
          context.fillStyle = bgColor;
          context.fillRect(0, 0, canvasWidth, canvasHeight);
          // rails
          context.fillStyle = railColor;
          context.fillRect(marginRail, marginRail, canvasWidth - (marginRail*2), canvasHeight - (marginRail*2));
          // cushions
          context.fillStyle = cushionColor;
          context.fillRect(marginCushion, marginCushion, canvasWidth - (marginCushion*2), canvasHeight - (marginCushion*2));
          // clothe
          context.fillStyle = tableColor;
          context.fillRect(marginClothe, marginClothe, canvasWidth - (marginClothe*2), canvasHeight - (marginClothe*2));
          // grid
          for (var x = spaceGrid+marginClothe; x < canvasWidth-marginClothe; x += spaceGrid) {
            context.moveTo(x, marginClothe);
            context.lineTo(x, canvasHeight-marginClothe);
          }
          for (var y = spaceGrid+marginClothe; y < canvasHeight-marginClothe; y += spaceGrid) {
            context.moveTo(marginClothe, y);
            context.lineTo(canvasWidth-marginClothe, y);
          }
          context.strokeStyle = gridColor;
          context.stroke();
          // english diagram
          context.font = '14px verdana';
          context.beginPath();
          context.arc(500, 287, 106.5, 0, 2 * Math.PI, false);
          context.stroke();
          context.beginPath();
          context.arc(500, 287, 79.875, 0, 2 * Math.PI, false);
          context.stroke();
          context.beginPath();
          context.arc(500, 207.125, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorN;
          context.fill();
          context.fillText('0', 495.75, 196.125);
          context.beginPath();
          context.arc(556.5, 230.5, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorR12;
          context.fill();
          context.fillText('½', 560.5, 226.5);
          context.beginPath();
          context.arc(443.5, 230.5, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorL12;
          context.fill();
          context.fillText('½', 423.5, 226.5);
          context.beginPath();
          context.arc(579.875, 287, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorR;
          context.fill();
          context.fillText('R', 590, 292);
          context.beginPath();
          context.arc(420.125, 287, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorL;
          context.fill();
          context.fillText('L', 400, 292);
          context.beginPath();
          context.arc(573.8, 256.4, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorR34;
          context.fill();
          context.fillText('¾', 580.8, 256);
          context.beginPath();
          context.arc(530.6, 213.2, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorR14;
          context.fill();
          context.fillText('¼', 532, 207);
          context.beginPath();
          context.arc(426.2, 256.4, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorL34;
          context.fill();
          context.fillText('¾', 404, 256);
          context.beginPath();
          context.arc(469.4, 213.2, 6, 0, 2 * Math.PI, false);
          context.fillStyle = tipColorL14;
          context.fill();
          context.fillText('¼', 454, 207);
          // diamonds
          for (var x = marginClothe; x < canvasWidth-marginDiamond; x += spaceGrid) {
            context.beginPath();
            context.arc(x, marginDiamond, 1.75, 0, 2 * Math.PI, false);
            context.arc(x, canvasHeight-marginDiamond, 1.75, 0, 2 * Math.PI, false);
            context.fillStyle = diamondColor;
            context.fill();
          }
          for (var y = marginClothe; y < canvasHeight-marginDiamond; y += spaceGrid) {
            context.beginPath();
            context.arc(marginDiamond, y, 1.75, 0, 2 * Math.PI, false);
            context.arc(canvasWidth-marginDiamond, y, 1.75, 0, 2 * Math.PI, false);
            context.fillStyle = diamondColor;
            context.fill();
          }
          // break markers
          context.beginPath();
          //context.arc(287, 287, 1.5, 0, 2 * Math.PI, false);
          context.arc(marginClothe+spaceGrid*2, marginClothe+spaceGrid*1.5, 1, 0, 2 * Math.PI, false);
          context.fillStyle = makerColor;
          context.fill();
          context.beginPath();
          //context.arc(287, 233.75, 1.5, 0, 2 * Math.PI, false);
          context.arc(marginClothe+spaceGrid*2, marginClothe+spaceGrid*2, 1, 0, 2 * Math.PI, false);
          context.fillStyle = makerColor;
          context.fill();
          context.beginPath();
          //context.arc(287, 340.25, 1.5, 0, 2 * Math.PI, false);
          context.arc(marginClothe+spaceGrid*2, marginClothe+spaceGrid*2.5, 1, 0, 2 * Math.PI, false);
          context.fillStyle = makerColor;
          context.fill();
          context.beginPath();
          //context.arc(713, 287, 2, 0, 2 * Math.PI, false);
          context.arc(marginClothe+spaceGrid*6, marginClothe+spaceGrid*2, 1, 0, 2 * Math.PI, false);
          context.fillStyle = makerColor;
          context.fill();
          // balls
          if (xWhite > canvasWidth-marginClothe-ballRadius) {
            xWhite = canvasWidth-marginClothe-ballRadius;
          }
          if (xWhite < marginClothe+ballRadius) {
            xWhite = marginClothe+ballRadius;
          }
          if (yWhite > canvasHeight-marginClothe-ballRadius) {
            yWhite = canvasHeight-marginClothe-ballRadius;
          }
          if (yWhite < marginClothe+ballRadius) {
            yWhite = marginClothe+ballRadius;
          }
          whiteGradient = context.createRadialGradient(xWhite - 2, yWhite - 2, 2, xWhite - 2, yWhite - 2, 9);
          whiteGradient.addColorStop(0, "#fff");
          whiteGradient.addColorStop(1, "#ddd");
          context.beginPath();
          context.arc(xWhite, yWhite, ballRadius, 0, 2 * Math.PI, false);
          context.fillStyle = whiteGradient;
          context.fill();
          context.beginPath();
          context.arc(0, 0, 0, 0, 2 * Math.PI, false);
          context.fillStyle = 0;
          context.fill();
        }

        const TABLE = {
          LEFT: 83, RIGHT: 917, TOP: 83, BOTTOM: 491,
          WIDTH: 834, HEIGHT: 408,
          EXT_SHORT: 37, OFFSET_X: 213, OFFSET_Y: 426,
          ADJ_CUE: 80, ADJ_FACTOR: 1.15, MAIN_MULT: 1.75,
          ENGLISH_ADJ: 0.05  // Giảm để xoáy nhẹ hơn, tránh lệch quá mức
        };

        function mouseDown(e) {
          draw();
          e.preventDefault();
          getMousePos(e);

          // Vector hướng từ bi trắng đến chuột
          const dx = mouseX - xWhite;
          const dy = mouseY - yWhite;
          const length = Math.sqrt(dx * dx + dy * dy);
          if (length === 0) return; // Không vẽ nếu chuột tại bi trắng

          let currDx = dx / length;
          let currDy = dy / length;

          // Tính ratio cho adj và extension
          const ratio = dx / -dy;
          const isAdjOn = document.getElementById('adjOn').checked;
          const adjV = isAdjOn ? TABLE.ADJ_CUE * ratio : 0;
          const adjH = isAdjOn ? TABLE.ADJ_CUE / ratio : 0;

          context.strokeStyle = "#fff";

          // Helper vẽ đường và bóng
          function drawLineAndBall(fromX, fromY, toX, toY) {
            context.beginPath();
            context.moveTo(fromX, fromY);
            context.lineTo(toX, toY);
            context.stroke();
            context.beginPath();
            context.arc(toX, toY, ballRadius, 0, 2 * Math.PI, false);
            context.stroke();
          }

          // Helper vẽ extension đỏ
          function drawRedExtension(borderX, borderY) {
            let extX = borderX, extY = borderY;
            if (Math.abs(borderY - TABLE.TOP) < 1) {
              extX += TABLE.EXT_SHORT * ratio;
              extY -= TABLE.EXT_SHORT;
            } else if (Math.abs(borderX - TABLE.RIGHT) < 1) {
              extX += TABLE.EXT_SHORT;
              extY -= TABLE.EXT_SHORT / ratio;
            } else if (Math.abs(borderY - TABLE.BOTTOM) < 1) {
              extX -= TABLE.EXT_SHORT * ratio;
              extY += TABLE.EXT_SHORT;
            } else if (Math.abs(borderX - TABLE.LEFT) < 1) {
              extX -= TABLE.EXT_SHORT;
              extY += TABLE.EXT_SHORT / ratio;
            }
            context.strokeStyle = "#f00";
            context.beginPath();
            context.moveTo(borderX, borderY);
            context.lineTo(extX, extY);
            context.stroke();
            context.strokeStyle = "#fff";
          }

          // Helper clip điểm đến biên gần nhất
          function clipPoint(fromX, fromY, nextX, nextY) {
            let clippedX = nextX, clippedY = nextY;
            let t = Infinity;
            const dx = nextX - fromX;
            const dy = nextY - fromY;
            let hitBorder = null;

            // Tính fraction cho từng biên
            if (dx !== 0) {
              const tLeft = (TABLE.LEFT - fromX) / dx;
              const tRight = (TABLE.RIGHT - fromX) / dx;
              if (tLeft > 0 && tLeft < t) { t = tLeft; clippedX = TABLE.LEFT; clippedY = fromY + t * dy; hitBorder = 'left'; }
              if (tRight > 0 && tRight < t) { t = tRight; clippedX = TABLE.RIGHT; clippedY = fromY + t * dy; hitBorder = 'right'; }
            }
            if (dy !== 0) {
              const tTop = (TABLE.TOP - fromY) / dy;
              const tBottom = (TABLE.BOTTOM - fromY) / dy;
              if (tTop > 0 && tTop < t) { t = tTop; clippedY = TABLE.TOP; clippedX = fromX + t * dx; hitBorder = 'top'; }
              if (tBottom > 0 && tBottom < t) { t = tBottom; clippedY = TABLE.BOTTOM; clippedX = fromX + t * dx; hitBorder = 'bottom'; }
            }

            return { x: clippedX, y: clippedY, hitBorder };
          }

          // Vẽ path với 6 segments
          const maxSegments = 8; // Có thể chỉnh dựa trên lực đánh
          let currX = xWhite;
          let currY = yWhite;
          let firstBorderX, firstBorderY;

          for (let i = 0; i < maxSegments - 1; i++) {
            // Tính điểm tiếp theo
            const scale = 10000; // Lớn để đảm bảo chạm biên
            let nextX = currX + currDx * scale;
            let nextY = currY + currDy * scale;

            // Áp dụng adj và english từ đoạn 2
            if (i > 0) {
              const isHorizontal = Math.abs(currDx) > Math.abs(currDy);
              nextX += isHorizontal ? adjV : adjH;
              nextY += isHorizontal ? adjH : adjV;
              nextX += TABLE.OFFSET_X * english * (currDx > 0 ? 1 : -1) * (isAdjOn && english !== 0 ? TABLE.MAIN_MULT : 1);
              nextY += TABLE.OFFSET_Y * english * (currDy > 0 ? 1 : -1) * (isAdjOn && english !== 0 ? TABLE.MAIN_MULT : 1);
            }

            const { x: clippedX, y: clippedY, hitBorder } = clipPoint(currX, currY, nextX, nextY);
            drawLineAndBall(currX, currY, clippedX, clippedY);

            if (i === 0) {
              firstBorderX = clippedX;
              firstBorderY = clippedY;
            }

            currX = clippedX;
            currY = clippedY;

            // Bounce dựa trên biên chạm
            if (hitBorder === 'left' || hitBorder === 'right') currDx = -currDx;
            if (hitBorder === 'top' || hitBorder === 'bottom') currDy = -currDy;

            // Điều chỉnh xoáy
            const englishAdj = english * TABLE.ENGLISH_ADJ;
            const tempDx = currDx;
            currDx += englishAdj * currDy;
            currDy -= englishAdj * tempDx;
            const newLength = Math.sqrt(currDx * currDx + currDy * currDy);
            if (newLength !== 0) {
              currDx /= newLength;
              currDy /= newLength;
            }
          }

          // Vẽ extension đỏ
          if (firstBorderX !== undefined) drawRedExtension(firstBorderX, firstBorderY);
        }

        function toggleColor() {
          if (tableColor == '#37f') {
            tableColor = '#207050';
            railColor = '#704030';
            cushionColor = '#105040';
            gridColor = '#1a6a4a';
          } else if (tableColor == '#207050') {
            tableColor = '#37f';
            railColor = '#000';
            cushionColor = '#15f';
            gridColor = '#48f';
          }
          tipColorL = gridColor;
          tipColorL34 = gridColor;
          tipColorL12 = gridColor;
          tipColorL14 = gridColor;
          tipColorN = cushionColor;
          tipColorR14 = gridColor;
          tipColorR12 = gridColor;
          tipColorR34 = gridColor;
          tipColorR = gridColor;
          draw();
        }
        var tipColorL = gridColor;
        var tipColorL34 = gridColor;
        var tipColorL12 = gridColor;
        var tipColorL14 = gridColor;
        var tipColorN = cushionColor;
        var tipColorR14 = gridColor;
        var tipColorR12 = gridColor;
        var tipColorR34 = gridColor;
        var tipColorR = gridColor;

        function changeTipColor() {
          if (document.getElementById('tipL').checked) {
            tipColorL = cushionColor;
            tipColorL34 = gridColor;
            tipColorL12 = gridColor;
            tipColorL14 = gridColor;
            tipColorN = gridColor;
            tipColorR14 = gridColor;
            tipColorR12 = gridColor;
            tipColorR34 = gridColor;
            tipColorR = gridColor;
            draw();
          } else if (document.getElementById('tipN').checked) {
            tipColorL = gridColor;
            tipColorL34 = gridColor;
            tipColorL12 = gridColor;
            tipColorL14 = gridColor
            tipColorN = cushionColor;
            tipColorR14 = gridColor;
            tipColorR12 = gridColor;
            tipColorR34 = gridColor;
            tipColorR = gridColor;
            draw();
          } else if (document.getElementById('tipR').checked) {
            tipColorL = gridColor;
            tipColorL34 = gridColor;
            tipColorL12 = gridColor;
            tipColorL14 = gridColor;
            tipColorN = gridColor;
            tipColorR14 = gridColor;
            tipColorR12 = gridColor;
            tipColorR34 = gridColor;
            tipColorR = cushionColor;
            draw();
          } else if (document.getElementById('tipL14').checked) {
            tipColorL = gridColor;
            tipColorL34 = gridColor;
            tipColorL12 = gridColor;
            tipColorL14 = cushionColor;
            tipColorN = gridColor;
            tipColorR14 = gridColor;
            tipColorR12 = gridColor;
            tipColorR34 = gridColor;
            tipColorR = gridColor;
            draw();
          } else if (document.getElementById('tipL12').checked) {
            tipColorL = gridColor;
            tipColorL34 = gridColor;
            tipColorL12 = cushionColor;
            tipColorL14 = gridColor;
            tipColorN = gridColor;
            tipColorR14 = gridColor;
            tipColorR12 = gridColor;
            tipColorR34 = gridColor;
            tipColorR = gridColor;
            draw();
          } else if (document.getElementById('tipL34').checked) {
            tipColorL = gridColor;
            tipColorL34 = cushionColor;
            tipColorL12 = gridColor;
            tipColorL14 = gridColor;
            tipColorN = gridColor;
            tipColorR14 = gridColor;
            tipColorR12 = gridColor;
            tipColorR34 = gridColor;
            tipColorR = gridColor;
            draw();
          } else if (document.getElementById('tipR14').checked) {
            tipColorL = gridColor;
            tipColorL34 = gridColor;
            tipColorL12 = gridColor;
            tipColorL14 = gridColor;
            tipColorN = gridColor;
            tipColorR14 = cushionColor;
            tipColorR12 = gridColor;
            tipColorR34 = gridColor;
            tipColorR = gridColor;
            draw();
          } else if (document.getElementById('tipR12').checked) {
            tipColorL = gridColor;
            tipColorL34 = gridColor;
            tipColorL12 = gridColor;
            tipColorL14 = gridColor;
            tipColorN = gridColor;
            tipColorR14 = gridColor;
            tipColorR12 = cushionColor;
            tipColorR34 = gridColor;
            tipColorR = gridColor;
            draw();
          } else if (document.getElementById('tipR34').checked) {
            tipColorL = gridColor;
            tipColorL34 = gridColor;
            tipColorL12 = gridColor;
            tipColorL14 = gridColor;
            tipColorN = gridColor;
            tipColorR14 = gridColor;
            tipColorR12 = gridColor;
            tipColorR34 = cushionColor;
            tipColorR = gridColor;
            draw();
          }
        }

        // set to image
        function saveImg() {
          isDrawing = false;
          var download = document.getElementById("download");
          var dataURL = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
          download.setAttribute("href", dataURL);
        }

        function getMousePos(e) {
          if (!e) {
            var e = event;
          }
          if (e.offsetX) {
            mouseX = e.offsetX;
            mouseY = e.offsetY;
          } else if (e.layerX) {
            mouseX = e.layerX;
            mouseY = e.layerY;
          }
        }

        function doubleClick(e) {
          e.preventDefault();
          getMousePos(e);
          xWhite = mouseX;
          yWhite = mouseY;
          draw();
        }
        var english = 0;

        function changeEnglish(eng) {
          english = eng;
        }
      </script>
      <p>
      <form>
        <label>English: </label>
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipL" onclick="changeTipColor();changeEnglish(-1);" />Left
        </fieldset>
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipN" onclick="changeTipColor();changeEnglish(0);" checked />None
        </fieldset>
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipR" onclick="changeTipColor();changeEnglish(1);" />Right
        </fieldset>
        <br />
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipL34" onclick="changeTipColor();changeEnglish(-0.75);" />&frac34; left
        </fieldset>
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipL12" onclick="changeTipColor();changeEnglish(-0.5);" />&frac12; left
        </fieldset>
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipL14" onclick="changeTipColor();changeEnglish(-0.25);" />&frac14; left
        </fieldset>
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipR14" onclick="changeTipColor();changeEnglish(0.25);" />&frac14; right
        </fieldset>
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipR12" onclick="changeTipColor();changeEnglish(0.5);" />&frac12; right
        </fieldset>
        <fieldset>
          <input type="radio" class="radio" name="english" id="tipR34" onclick="changeTipColor();changeEnglish(0.75);" />&frac34; right
        </fieldset>
      </form>
      </p>
      <p>
      <form>
        <label>Adjustments: </label>
        <fieldset>
          <input type="radio" class="radio" name="english" id="adjOn" checked />On
        </fieldset>
        <fieldset>
          <input type="radio" class="radio" name="english" id="adjOff" />Off
        </fieldset>
      </form>
      </p>
      <p>
        <button onclick="toggleColor();">Toggle green/blue</button>
      </p>
      <p>
        <a id="download" download="screenshot.png">
          <button onclick="saveImg();">Save as image</button>
        </a>
      </p>
      <p>
        <button onclick="window.location.href = 'index.html';">Home</button>
      </p>
  </body>
</html>